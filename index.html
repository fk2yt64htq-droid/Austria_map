<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Austria Map</title>

<!-- Leaflet (—Ä–µ–∞–ª—å–Ω—ñ —Ñ–∞–π–ª–∏) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Telegram WebApp -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
html, body { margin: 0; padding: 0; height: 100%; background: #fff; }
#map { height: 100vh; width: 100vw; }
.btn { width: 100%; padding: 12px; margin-top: 6px; border: none; border-radius: 8px; color: #fff; font-weight: bold; cursor: pointer; }
.leaflet-popup-content { color: #000 !important; text-align: center; }
</style>
</head>
<body>

<div id="map"></div>

<script>
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

// —Ç–≤—ñ–π –±–µ–∫–µ–Ω–¥ (–ø–æ–∫–∏ –º–æ–∂–µ –Ω–µ —ñ—Å–Ω—É–≤–∞—Ç–∏ ‚Äî —Ç–æ–¥—ñ –ø—Ä–æ—Å—Ç–æ –Ω–µ –±—É–¥–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏)
const API_URL = "https://austria-map.onrender.com"; 

const dots = [
 {id:1,n:"H√∂rbranz A14",lt:47.5446,ln:9.7407},
 {id:2,n:"Nuziders A14",lt:47.1731,ln:9.7737},
 {id:3,n:"Rabfeld A12",lt:47.4574,ln:11.9196},
 {id:4,n:"Kundl A12",lt:47.4734,ln:11.9693},
 {id:5,n:"Wels A8",lt:48.1790,ln:13.8623},
 {id:6,n:"Wolfsbach A1 (1)",lt:48.1120,ln:14.6761},
 {id:7,n:"Wolfsbach A1 (2)",lt:48.1123,ln:14.6786},
 {id:8,n:"Mistelbach A5",lt:48.5389,ln:16.6259},
 {id:9,n:"Bruck an der Leitha A4",lt:48.0431,ln:16.7791},
 {id:10,n:"Pernau A2",lt:47.0900,ln:15.8511},
 {id:11,n:"Strass in Steiermark A9",lt:46.7317,ln:15.6436},
 {id:12,n:"Hainburg A2",lt:46.6845,ln:14.6591},
 {id:13,n:"Arnoldstein A2",lt:46.5492,ln:13.7042}
];

let map, markers = {}, stats = {};

function init() {
  map = L.map("map").setView([47.5162, 14.5501], 7);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  loadStats();
  setInterval(loadStats, 10000); // –∞–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–∂–Ω—ñ 10—Å
}

async function loadStats() {
  try {
    const res = await fetch(API_URL + "/stats");
    stats = await res.json();
  } catch {
    stats = {};
  }

  dots.forEach(p => {
    const s = stats[p.id] || {green:0, red:0};
    const total = s.green + s.red;
    const redP = total ? Math.round((s.red/total)*100) : 0;

    let color = "blue";
    if (total > 0) color = redP >= 50 ? "red" : "green";

    const iconUrl = `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png`;

    if (!markers[p.id]) {
      markers[p.id] = L.marker([p.lt, p.ln]).addTo(map);
      L.circle([p.lt, p.ln], {
        radius: 1500,
        color: "blue",
        weight: 1,
        fillOpacity: 0.1
      }).addTo(map);
    }

    markers[p.id].setIcon(new L.Icon({
      iconUrl: iconUrl,
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
      iconSize: [25,41],
      iconAnchor: [12,41],
      popupAnchor: [1,-34],
      shadowSize: [41,41]
    }));

    markers[p.id].bindPopup(`
      <b>${p.n}</b><br>
      üî¥ –ö–æ–Ω—Ç—Ä–æ–ª—å: ${redP}%<br>
      üü¢ –ß–∏—Å—Ç–æ: ${100-redP}%<br>
      <button class="btn" style="background:green" onclick="sendVote(${p.id},'green')">–ß–ò–°–¢–û</button>
      <button class="btn" style="background:red" onclick="sendVote(${p.id},'red')">–ö–û–ù–¢–†–û–õ–¨</button>
    `);
  });
}

window.sendVote = async (id, status) => {
  try {
    await fetch(API_URL + "/update", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({id, status})
    });
  } catch {}

  tg.sendData(status + "_" + id);
  loadStats();
};

init();
</script>
</body>
</html>
