<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Austria Map</title>
    <!-- –í–∏–ø—Ä–∞–≤–ª–µ–Ω—ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net">
    <script src="https://cdn.jsdelivr.net"></script>
    <script src="https://telegram.org"></script>
    <style>
        html, body { margin: 0; padding: 0; height: 100%; background: #000; }
        #map { height: 100vh; width: 100vw; }
        .btn { width: 100%; padding: 12px; margin-top: 6px; border: none; border-radius: 8px; color: #fff; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
<div id="map"></div>
<script>
    let tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    // !!! –í–°–¢–ê–í–¢–ï –í–ê–®–ï –ü–û–°–ò–õ–ê–ù–ù–Ø –ó RENDER –ù–ò–ñ–ß–ï !!!
    const API_URL = "–í–°–¢–ê–í–¢–ï_–¢–£–¢_–í–ê–®–ï_–ü–û–°–ò–õ–ê–ù–ù–Ø_–ó_RENDER"; 

    const map = L.map("map").setView([47.5162, 14.5501], 7);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    const dots = [
        {"id": 1, "n": "H√∂rbranz A14", "lt": 47.5446, "ln": 9.7407},
        {"id": 2, "n": "Nuziders A14", "lt": 47.1731, "ln": 9.7737},
        {"id": 3, "n": "Rabfeld A12", "lt": 47.4574, "ln": 11.9196},
        {"id": 4, "n": "Kundl A12", "lt": 47.4734, "ln": 11.9693},
        {"id": 5, "n": "Wels A8", "lt": 48.1790, "ln": 13.8623},
        {"id": 6, "n": "Wolfsbach A1 (1)", "lt": 48.1120, "ln": 14.6761},
        {"id": 7, "n": "Wolfsbach A1 (2)", "lt": 48.1123, "ln": 14.6786},
        {"id": 8, "n": "Mistelbach A5", "lt": 48.5389, "ln": 16.6259},
        {"id": 9, "n": "Bruck an der Leitha A4", "lt": 48.0431, "ln": 16.7791},
        {"id": 10, "n": "Pernau A2", "lt": 47.0900, "ln": 15.8511},
        {"id": 11, "n": "Strass in Steiermark A9", "lt": 46.7317, "ln": 15.6436},
        {"id": 12, "n": "Hainburg A2", "lt": 46.6845, "ln": 14.6591},
        {"id": 13, "n": "Arnoldstein A2", "lt": 46.5492, "ln": 13.7042}
    ];

    const markers = {};

    async function loadStats() {
        try {
            const response = await fetch(`${API_URL}/stats`);
            const statsData = await response.json();

            dots.forEach(p => {
                const s = statsData[p.id] || { green: 0, red: 0 };
                const total = s.green + s.red;
                const redPerc = total > 0 ? Math.round((s.red / total) * 100) : 0;
                const greenPerc = total > 0 ? 100 - redPerc : 0;

                let color = "blue";
                if (total > 0) color = redPerc >= 50 ? "red" : "green";

                const icon = new L.Icon({
                    iconUrl: `https://raw.githubusercontent.com{color}.png`,
                    shadowUrl: 'https://cdnjs.cloudflare.com',
                    iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
                });

                if (markers[p.id]) {
                    markers[p.id].setIcon(icon);
                    markers[p.id].setPopupContent(createPopupContent(p, redPerc, greenPerc, total));
                } else {
                    markers[p.id] = L.marker([p.lt, p.ln], { icon: icon }).addTo(map)
                        .bindPopup(createPopupContent(p, redPerc, greenPerc, total));
                }
            });
        } catch (e) { console.log("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"); }
    }

    function createPopupContent(p, redPerc, greenPerc, total) {
        return `
            <b>${p.n}</b><br>
            <div style="color:gray; font-size:12px;">üî¥ –ö–æ–Ω—Ç—Ä–æ–ª—å: ${redPerc}% | üü¢ –ß–∏—Å—Ç–æ: ${greenPerc}%</div>
            <div style="color:gray; font-size:10px; margin-bottom:5px;">(–í—Å—å–æ–≥–æ –≥–æ–ª–æ—Å—ñ–≤: ${total})</div>
            <button class="btn" style="background:green" onclick="sendVote(${p.id}, 'green')">–ß–ò–°–¢–û</button>
            <button class="btn" style="background:red" onclick="sendVote(${p.id}, 'red')">–ö–û–ù–¢–†–û–õ–¨</button>
        `;
    }

    window.sendVote = async (id, status) => {
        try {
            // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –Ω–∞ –≤–∞—à –Ω–æ–≤–∏–π —Å–µ—Ä–≤–µ—Ä server.py
            await fetch(`${API_URL}/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id, status: status })
            });
            
            // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –±–æ—Ç—É (—è–∫ —ñ —Ä–∞–Ω—ñ—à–µ)
            tg.sendData(status + "_" + id);
            
            // –û–Ω–æ–≤–ª—é—î–º–æ –¥–∞–Ω—ñ –Ω–∞ –º–∞–ø—ñ
            loadStats();
        } catch (e) {
            alert("–ü–æ–º–∏–ª–∫–∞ –∑–≤'—è–∑–∫—É —ñ–∑ —Å–µ—Ä–≤–µ—Ä–æ–º!");
        }
    };

    // –û–Ω–æ–≤–ª—é–≤–∞—Ç–∏ –∫–æ–∂–Ω—ñ 15 —Å–µ–∫—É–Ω–¥
    loadStats();
    setInterval(loadStats, 15000);
</script>
</body>
</html>
