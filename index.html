<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Austria Map</title>
    <!-- –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Å—Ç–∏–ª—ñ–≤ –∫–∞—Ä—Ç–∏ -->
    <link rel="stylesheet" href="https://unpkg.com" />
    <style>
        html, body { margin: 0; padding: 0; height: 100%; background: #000; }
        #map { height: 100vh; width: 100vw; background: #000; }
        .btn { width: 100%; padding: 12px; margin-top: 6px; border: none; border-radius: 8px; color: #fff; font-weight: bold; cursor: pointer; }
        .leaflet-popup-content-wrapper { border-radius: 12px; }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Å–∫—Ä–∏–ø—Ç—ñ–≤ -->
    <script src="https://unpkg.com"></script>
    <script src="https://telegram.org"></script>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // –í–ê–ñ–õ–ò–í–û: –í—Å—Ç–∞–≤—Ç–µ —Å—é–¥–∏ –≤–∞—à–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –∑ Render (–≤–æ–Ω–æ –º–∞—î –±—É—Ç–∏ LIVE)
        const API_URL = "https://–í–ê–®_–ü–†–û–ï–ö–¢.onrender.com"; 

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–∞—Ä—Ç–∏
        const map = L.map("map").setView([47.5162, 14.5501], 7);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        const dots = [
            {"id": 1, "n": "H√∂rbranz A14", "lt": 47.5446, "ln": 9.7407},
            {"id": 2, "n": "Nuziders A14", "lt": 47.1731, "ln": 9.7737},
            {"id": 3, "n": "Rabfeld A12", "lt": 47.4574, "ln": 11.9196},
            {"id": 4, "n": "Kundl A12", "lt": 47.4734, "ln": 11.9693},
            {"id": 5, "n": "Wels A8", "lt": 48.1790, "ln": 13.8623},
            {"id": 6, "n": "Wolfsbach A1 (1)", "lt": 48.1120, "ln": 14.6761},
            {"id": 7, "n": "Wolfsbach A1 (2)", "lt": 48.1123, "ln": 14.6786},
            {"id": 8, "n": "Mistelbach A5", "lt": 48.5389, "ln": 16.6259},
            {"id": 9, "n": "Bruck an der Leitha A4", "lt": 48.0431, "ln": 16.7791},
            {"id": 10, "n": "Pernau A2", "lt": 47.0900, "ln": 15.8511},
            {"id": 11, "n": "Strass in Steiermark A9", "lt": 46.7317, "ln": 15.6436},
            {"id": 12, "n": "Hainburg A2", "lt": 46.6845, "ln": 14.6591},
            {"id": 13, "n": "Arnoldstein A2", "lt": 46.5492, "ln": 13.7042}
        ];

        const markers = {};
        let stats = {};

        function createPopup(p, redPerc, greenPerc, total) {
            return `
                <div style="text-align:center; min-width:150px; color:#000;">
                    <b>${p.n}</b><br>
                    üî¥ ${redPerc}% | üü¢ ${greenPerc}%<br>
                    <small>–í—Å—å–æ–≥–æ: ${total}</small>
                    <button class="btn" style="background:green" onclick="sendVote(${p.id}, 'green')">–ß–ò–°–¢–û</button>
                    <button class="btn" style="background:red" onclick="sendVote(${p.id}, 'red')">–ö–û–ù–¢–†–û–õ–¨</button>
                </div>
            `;
        }

        async function loadStats() {
            try {
                const response = await fetch(`${API_URL}/stats`);
                stats = await response.json();
                
                dots.forEach(p => {
                    const s = stats[p.id] || { green: 0, red: 0 };
                    const total = s.green + s.red;
                    const rPerc = total > 0 ? Math.round((s.red / total) * 100) : 0;
                    const gPerc = total > 0 ? 100 - rPerc : 0;

                    let color = "blue";
                    if (total > 0) color = rPerc >= 50 ? "red" : "green";

                    const icon = L.icon({
                        iconUrl: `https://raw.githubusercontent.com{color}.png`,
                        shadowUrl: 'https://cdnjs.cloudflare.com',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34]
                    });

                    if (markers[p.id]) {
                        markers[p.id].setIcon(icon);
                        markers[p.id].setPopupContent(createPopup(p, rPerc, gPerc, total));
                    } else {
                        markers[p.id] = L.marker([p.lt, p.ln], { icon: icon }).addTo(map)
                            .bindPopup(createPopup(p, rPerc, gPerc, total));
                        L.circle([p.lt, p.ln], { radius: 1500, color: 'blue', weight: 1, fillOpacity: 0.1 }).addTo(map);
                    }
                });
            } catch (e) {
                console.error("–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:", e);
            }
        }

        window.sendVote = async (id, status) => {
            try {
                await fetch(`${API_URL}/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id, status: status })
                });
                loadStats();
                tg.sendData(status + "_" + id);
            } catch (e) {
                alert("–°–µ—Ä–≤–µ—Ä –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î");
            }
        };

        // –°—Ç–∞—Ä—Ç
        loadStats();
        setInterval(loadStats, 10000);
    </script>
</body>
</html>
