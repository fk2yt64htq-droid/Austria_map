import asyncio
import json
import os
import urllib.parse
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command
from aiogram.types import WebAppInfo, ReplyKeyboardMarkup, KeyboardButton

TOKEN = "8106544754:AAGdcip8weOAYiCYARU3eatZuKjk2a6FePA"
URL_MAP = "https://fk2yt64htq-droid.github.io" 
DB_FILE = "stats.json"

# –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
def load_stats():
    if not os.path.exists(DB_FILE):
        return {}
    with open(DB_FILE, "r") as f:
        try:
            return json.load(f)
        except: return {}

def save_stats(stats):
    with open(DB_FILE, "w") as f:
        json.dump(stats, f)

bot = Bot(token=TOKEN)
dp = Dispatcher()

@dp.message(Command("start"))
async def start_cmd(message: types.Message):
    stats = load_stats()
    # –ö–æ–¥—É—î–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É, —â–æ–± –ø–µ—Ä–µ–¥–∞—Ç–∏ —ó—ó –º–∞–ø—ñ —á–µ—Ä–µ–∑ URL
    encoded_stats = urllib.parse.quote(json.dumps(stats))
    final_url = f"{URL_MAP}?stats={encoded_stats}"
    
    kb = ReplyKeyboardMarkup(
        keyboard=[[KeyboardButton(text="üó∫ –í—ñ–¥–∫—Ä–∏—Ç–∏ –º–∞–ø—É", web_app=WebAppInfo(url=final_url))]],
        resize_keyboard=True
    )
    await message.answer("–ú–∞–ø–∞ –∑ –∞–∫—Ç—É–∞–ª—å–Ω–æ—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ—é –≥–æ—Ç–æ–≤–∞:", reply_markup=kb)

@dp.message(F.web_app_data)
async def get_data(message: types.Message):
    try:
        # –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –≤—ñ–¥ –º–∞–ø–∏, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥ "red_1"
        status, point_id = message.web_app_data.data.split("_")
        stats = load_stats()

        if point_id not in stats:
            stats[point_id] = {"green": 0, "red": 0}
        
        stats[point_id][status] += 1
        save_stats(stats)

        await message.answer(f"‚úÖ –°—Ç–∞—Ç—É—Å –æ–Ω–æ–≤–ª–µ–Ω–æ! –î—è–∫—É—î–º–æ –∑–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é.")
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞: {e}")

async def main():
    print("--- –ë–û–¢ –ü–†–ê–¶–Æ–Ñ ---")
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
