<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; }
        #map { height: 100vh; width: 100vw; }
        .btn { padding: 10px; width: 100%; margin-top: 5px; color: white; border: none; font-weight: bold; border-radius: 5px; }
        .btn-g { background: #28a745; }
        .btn-r { background: #dc3545; }
        .progress-bar { width: 100%; height: 8px; background: #eee; border-radius: 4px; margin: 5px 0; overflow: hidden; display: flex; }
        /* –ö–æ–ª—å–æ—Ä–∏ –º–∞—Ä–∫–µ—Ä—ñ–≤ */
        .m-red { filter: hue-rotate(140deg) saturate(3); }
        .m-green { filter: hue-rotate(250deg) saturate(3); }
        .m-blue { filter: none; }
    </style>
</head>
<body>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const map = L.map('map').setView([47.5, 13.5], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // –ì–µ–æ–ø–æ–∑–∏—Ü—ñ—è –≤–æ–¥—ñ—è
        function onLocationFound(e) {
            if (window.userMarker) window.userMarker.setLatLng(e.latlng);
            else window.userMarker = L.circleMarker(e.latlng, {radius: 7, fillColor: "#007AFF", color: "#fff", weight: 2, fillOpacity: 1}).addTo(map);
        }
        map.on('locationfound', onLocationFound);
        map.locate({setView: false, watch: true});

        // –î–∞–Ω—ñ –∑ —Å–µ—Ä–≤–µ—Ä–∞
        let stats = {};
        const params = new URLSearchParams(window.location.search);
        const dataRaw = params.get('data');
        if (dataRaw) { try { stats = JSON.parse(decodeURIComponent(dataRaw)); } catch(e) {} }

        const locations = [
            {id: 1, n: "H√∂rbranz A14", lt: 47.5446, ln: 9.7407},
            {id: 2, n: "Nuziders A14", lt: 47.1731, ln: 9.7737},
            {id: 3, n: "Rabfeld A12", lt: 47.4574, ln: 11.9196},
            {id: 4, n: "Kundl A12", lt: 47.4734, ln: 11.9693},
            {id: 5, n: "Wels A8", lt: 48.1790, ln: 13.8623},
            {id: 6, n: "Wolfsbach A1 (1)", lt: 48.1120, ln: 14.6761},
            {id: 7, n: "Wolfsbach A1 (2)", lt: 48.1123, ln: 14.6786},
            {id: 8, n: "Mistelbach A5", lt: 48.5389, ln: 16.6259},
            {id: 9, n: "Bruck an der Leitha A4", lt: 48.0431, ln: 16.7791},
            {id: 10, n: "Pernau A2", lt: 47.0900, ln: 15.8511},
            {id: 11, n: "Strass in Steiermark A9", lt: 46.7317, ln: 15.6436},
            {id: 12, n: "Hainburg A2", lt: 46.6845, ln: 14.6591},
            {id: 13, n: "Arnoldstein A2", lt: 46.5492, ln: 13.7042}
        ];

        locations.forEach(l => {
            let colorClass = "m-blue";
            let htmlStat = "–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö";
            
            if (stats[l.id]) {
                const r = stats[l.id].red_c || 0;
                const g = stats[l.id].green_c || 0;
                const total = r + g;
                colorClass = stats[l.id].status === 'red' ? "m-red" : "m-green";
                
                if (total > 0) {
                    const pr = Math.round((r/total)*100);
                    htmlStat = `<div class="progress-bar"><div style="width:${pr}%;background:red"></div><div style="width:${100-pr}%;background:green"></div></div>
                                <small>üî¥ ${pr}% | üü¢ ${100-pr}% (–ì–æ–ª–æ—Å—ñ–≤: ${total})</small>`;
                }
            }

            const m = L.marker([l.lt, l.ln]).addTo(map).bindPopup(`
                <div style="text-align:center">
                    <b>${l.n}</b><br>${htmlStat}<br>
                    <button class="btn btn-g" onclick="send(${l.id},'green')">–ß–ò–°–¢–û</button>
                    <button class="btn btn-r" onclick="checkDist(${l.id},'red')">–ö–û–ù–¢–†–û–õ–¨</button></div>
            `);
            
            m.on('add', function() { m._icon.classList.add(colorClass); });
        });

        function send(id, s) {
            tg.sendData(JSON.stringify({id: id, status: s}));
            tg.close();
        }

        function checkDist(id, s) {
            // –¢–∏–º—á–∞—Å–æ–≤–æ –±–µ–∑ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –¥–∏—Å—Ç–∞–Ω—Ü—ñ—ó –¥–ª—è —Ç–µ—Å—Ç—É
            send(id, s);
        }
    </script>
</body>
</html>
