<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Austria Map</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"/>
<style>
html, body { margin:0; padding:0; height:100%; }
#map { height:100%; width:100%; }
.btn { width: 100%; padding: 6px; margin-top: 5px; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
</style>
</head>
<body>
<div id="map"></div>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
const tg = window.Telegram.WebApp;
tg.ready(); tg.expand();

const API_URL = "https://–¢–í–û–ô_–°–ï–†–í–ï–†_URL:8080"; // URL –¥–æ —Ç–≤–æ–≥–æ main.py –Ω–∞ Render –∞–±–æ –ª–æ–∫–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ ngrok

const dots = [
  {id:1,n:"H√∂rbranz A14",lt:47.5446,ln:9.7407},
  {id:2,n:"Walserberg A1",lt:47.7925,ln:12.9772},
  {id:3,n:"Suben A8",lt:48.4112,ln:13.4393}
];

const map = L.map('map').setView([47.5162,14.5501],7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'¬© OpenStreetMap' }).addTo(map);

const markers = {};
let stats = {};

async function loadStats(){
  try{
    const response = await fetch(API_URL+'/stats');
    stats = await response.json();
    dots.forEach(p=>{
      const s = stats[p.id]||{green:0,red:0,last:0};
      const total = s.green+s.red;
      const rPerc = total>0?Math.round((s.red/total)*100):0;
      const gPerc = total>0?100-rPerc:0;

      // –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –æ—Å—Ç–∞–Ω–Ω—ñ—Ö 30 —Ö–≤
      const now = Math.floor(Date.now()/1000);
      const last = s.last || 0;
      let color = (now - last > 1800) ? 'blue' : (rPerc>=50?'red':'green');

      const icon = L.icon({
        iconUrl:`https://raw.githubusercontent.com{color}.png`,
        iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34]
      });

      if(!markers[p.id]){
        markers[p.id] = L.marker([p.lt,p.ln],{icon:icon}).addTo(map);
        L.circle([p.lt,p.ln],{radius:1500,color:'blue',weight:1,fillOpacity:0.1}).addTo(map);
      } else markers[p.id].setIcon(icon);

      markers[p.id].bindPopup(`
        <b>${p.n}</b><br>
        üî¥ ${rPerc}% | üü¢ ${gPerc}%<br>
        <button class="btn" style="background:green" onclick="vote(${p.id},'green')">–ß–ò–°–¢–û</button>
        <button class="btn" style="background:red" onclick="vote(${p.id},'red')">–ö–û–ù–¢–†–û–õ–¨</button>
      `);
    });
  }catch(e){console.log("–ü–æ–º–∏–ª–∫–∞ API",e);}
}

window.vote = async (id,status)=>{
  await fetch(API_URL+'/update',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({id:id,status:status})
  });
  loadStats();
  tg.sendData(status+'_'+id);
};

loadStats();
setInterval(loadStats,10000);
</script>
</body>
</html>
