<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ú–∞–ø–∞ —Ç–æ—á–æ–∫</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  html, body { margin:0; padding:0; height:100%; }
  #map { height:100%; width:100%; }
  .btn { width: 100%; padding: 6px; margin-top: 5px; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
</style>
</head>
<body>

<div id="map"></div>

<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<script>
// Telegram WebApp
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –º–∞–ø–∏
const map = L.map('map').setView([47.5162, 14.5501], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// –¢–æ—á–∫–∏
const points = [
    {id: 1, name: "H√∂rbranz A14", lat: 47.5446, lon: 9.7407},
    {id: 2, name: "Nuziders A14", lat: 47.1731, lon: 9.7737},
    {id: 3, name: "Rabfeld A12", lat: 47.4574, lon: 11.9196},
    {id: 4, name: "Kundl A12", lat: 47.4734, lon: 11.9693},
    {id: 5, name: "Wels A8", lat: 48.1790, lon: 13.8623},
    {id: 6, name: "Wolfsbach A1 (1)", lat: 48.1120, lon: 14.6761},
    {id: 7, name: "Wolfsbach A1 (2)", lat: 48.1123, lon: 14.6786},
    {id: 8, name: "Mistelbach A5", lat: 48.5389, lon: 16.6259},
    {id: 9, name: "Bruck an der Leitha A4", lat: 48.0431, lon: 16.7791},
    {id: 10, name: "Pernau A2", lat: 47.0900, lon: 15.8511},
    {id: 11, name: "Strass in Steiermark A9", lat: 46.7317, lon: 15.6436},
    {id: 12, name: "Hainburg A2", lat: 46.6845, lon: 14.6591},
    {id: 13, name: "Arnoldstein A2", lat: 46.5492, lon: 13.7042}
];

// –ú–∞—Ä–∫–µ—Ä–∏ —Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
const markers = {};
const stats = {}; // –ª–æ–∫–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –¥–ª—è –∫–æ–ª—å–æ—Ä—ñ–≤

function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371000; 
    const toRad = x => x * Math.PI/180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è popup
function updatePopup(id) {
    const marker = markers[id];
    const s = stats[id] || {green:0, red:0};
    const total = s.green + s.red;
    const rP = total>0? Math.round((s.red/total)*100) : 0;
    const gP = total>0? 100 - rP : 0;

    marker.getPopup().setContent(`
        <div style="text-align:center;">
            <b>${marker.options.title}</b><br>
            üî¥ ${rP}% | üü¢ ${gP}%<br>
            <button class="btn" style="background:green" onclick="trySend('${id}','green')">–ß–ò–°–¢–û</button>
            <button class="btn" style="background:red" onclick="trySend('${id}','red')">–ö–û–ù–¢–†–û–õ–¨</button>
        </div>
    `);
}

// –î–æ–¥–∞—î–º–æ –º–∞—Ä–∫–µ—Ä–∏
points.forEach(p=>{
    const marker = L.marker([p.lat,p.lon],{title:p.name}).addTo(map);
    markers[p.id] = marker;
    stats[p.id] = {green:0, red:0};
    marker.bindPopup('');
    updatePopup(p.id);
});

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏
function trySend(id,status){
    navigator.geolocation.getCurrentPosition(pos=>{
        const userLat = pos.coords.latitude;
        const userLon = pos.coords.longitude;
        const point = points.find(p=>p.id==id);
        const d = getDistance(userLat,userLon,point.lat,point.lon);
        if(d>15000000){
            alert(`‚ùå –í–∏ –∑–∞–Ω–∞–¥—Ç–æ –¥–∞–ª–µ–∫–æ –≤—ñ–¥ —Ç–æ—á–∫–∏ (${Math.round(d)} –º). –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –≤—ñ–¥—Å—Ç–∞–Ω—å ‚Äî 1500 –º.`);
            return;
        }
        // –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –Ω–∞ –±–æ—Ç
        tg.sendData(`${status}_${id}_${userLat}_${userLon}`);
        // –ó–º—ñ–Ω—é—î–º–æ –∫–æ–ª—ñ—Ä
        const color = status==='green'?'green':'red';
        markerIcon = L.icon({
            iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png`,
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
            iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]
        });
        markers[id].setIcon(markerIcon);
        // –õ–æ–∫–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        stats[id][status] += 1;
        updatePopup(id);
        alert(`‚úÖ –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ: ${status.toUpperCase()} –¥–ª—è —Ç–æ—á–∫–∏ ${point.name}`);
    }, err=>{
        alert("‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –≤–∞—à—É –≥–µ–æ–ø–æ–∑–∏—Ü—ñ—é.");
    });
}
</script>

</body>
</html>

