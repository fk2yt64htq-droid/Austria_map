<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Austria Map</title>
    <link rel="stylesheet" href="https://unpkg.com" />
    <style>
        html, body { margin: 0; padding: 0; height: 100%; background: #fff; }
        #map { height: 100vh; width: 100vw; }
        .btn { width: 100%; padding: 12px; margin-top: 6px; border: none; border-radius: 8px; color: #fff; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <div id="map"></div>

    <script src="https://unpkg.com"></script>
    <script src="https://telegram.org"></script>

    <script>
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ Telegram WebApp
        const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
        if (tg) {
            tg.ready();
            tg.expand();
        }

        // –í–ê–ñ–õ–ò–í–û: –í—Å—Ç–∞–≤—Ç–µ —Å—é–¥–∏ –≤–∞—à–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –∑ Render (https)
        const API_URL = "https://austria-map.onrender.com"; 

        const map = L.map("map").setView([47.5162, 14.5501], 7);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const dots = [
            {"id": 1, "n": "H√∂rbranz A14", "lt": 47.5446, "ln": 9.7407},
            {"id": 2, "n": "Nuziders A14", "lt": 47.1731, "ln": 9.7737},
            {"id": 3, "n": "Rabfeld A12", "lt": 47.4574, "ln": 11.9196},
            {"id": 4, "n": "Kundl A12", "lt": 47.4734, "ln": 11.9693},
            {"id": 5, "n": "Wels A8", "lt": 48.1790, "ln": 13.8623},
            {"id": 6, "n": "Wolfsbach A1 (1)", "lt": 48.1120, "ln": 14.6761},
            {"id": 7, "n": "Wolfsbach A1 (2)", "lt": 48.1123, "ln": 14.6786},
            {"id": 8, "n": "Mistelbach A5", "lt": 48.5389, "ln": 16.6259},
            {"id": 9, "n": "Bruck an der Leitha A4", "lt": 48.0431, "ln": 16.7791},
            {"id": 10, "n": "Pernau A2", "lt": 47.0900, "ln": 15.8511},
            {"id": 11, "n": "Strass in Steiermark A9", "lt": 46.7317, "ln": 15.6436},
            {"id": 12, "n": "Hainburg A2", "lt": 46.6845, "ln": 14.6591},
            {"id": 13, "n": "Arnoldstein A2", "lt": 46.5492, "ln": 13.7042}
        ];

        const markers = {};

        async function loadStats() {
            try {
                const response = await fetch(`${API_URL}/stats`);
                const statsData = await response.json();
                
                dots.forEach(p => {
                    const s = statsData[p.id] || { green: 0, red: 0 };
                    const total = s.green + s.red;
                    const rPerc = total > 0 ? Math.round((s.red / total) * 100) : 0;
                    
                    let color = "blue";
                    if (total > 0) color = rPerc >= 50 ? "red" : "green";

                    const icon = L.icon({
                        iconUrl: `https://raw.githubusercontent.com{color}.png`,
                        shadowUrl: 'https://cdnjs.cloudflare.com',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    });

                    if (markers[p.id]) {
                        markers[p.id].setIcon(icon);
                    } else {
                        markers[p.id] = L.marker([p.lt, p.ln], { icon: icon }).addTo(map);
                        L.circle([p.lt, p.ln], { radius: 1500, color: 'blue', weight: 1, fillOpacity: 0.1 }).addTo(map);
                    }

                    markers[p.id].bindPopup(`
                        <div style="text-align:center; color:#000;">
                            <b>${p.n}</b><br>
                            üî¥ –ö–æ–Ω—Ç—Ä–æ–ª—å: ${rPerc}% | üü¢ –ß–∏—Å—Ç–æ: ${100-rPerc}%<br>
                            <small>–í—Å—å–æ–≥–æ: ${total}</small><br>
                            <button class="btn" style="background:green" onclick="sendVote(${p.id}, 'green')">–ß–ò–°–¢–û</button>
                            <button class="btn" style="background:red" onclick="sendVote(${p.id}, 'red')">–ö–û–ù–¢–†–û–õ–¨</button>
                        </div>
                    `);
                });
            } catch (e) { console.error("Stats server error"); }
        }

        window.sendVote = async (id, status) => {
            try {
                await fetch(`${API_URL}/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id, status: status })
                });
                loadStats();
                if (tg) tg.sendData(status + "_" + id);
            } catch (e) { alert("–ü–æ–º–∏–ª–∫–∞ –∑–≤'—è–∑–∫—É!"); }
        };

        loadStats();
        setInterval(loadStats, 15000);
    </script>
</body>
</html>
