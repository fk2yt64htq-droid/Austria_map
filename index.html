<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Austria Road Control</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; }
        #map { height: 100vh; width: 100vw; }
        .btn { padding: 12px; width: 100%; margin-top: 8px; color: white; border: none; font-weight: bold; cursor: pointer; border-radius: 6px; font-size: 14px; }
        .btn-g { background: #28a745; }
        .btn-r { background: #dc3545; }
        .progress-bar-container { width: 100%; height: 10px; background: #eee; border-radius: 5px; margin: 10px 0; overflow: hidden; display: flex; }
        .stat-label { display: flex; justify-content: space-between; font-size: 12px; font-weight: bold; margin-bottom: 2px; }
        
        /* –°—Ç–∏–ª—å –¥–ª—è –∑–º—ñ–Ω–∏ –∫–æ–ª—å–æ—Ä—É —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞ */
        .marker-red { filter: hue-rotate(140deg) brightness(90%) saturate(150%); }
        .marker-green { filter: hue-rotate(260deg) brightness(90%) saturate(150%); }
        .marker-blue { filter: none; } /* –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π */
    </style>
</head>
<body>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const map = L.map('map').setView([47.5, 13.5], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // --- –í–ê–®–ê –ì–ï–û–ü–û–ó–ò–¶–Ü–Ø (–°–∏–Ω—è —Ç–æ—á–∫–∞) ---
        function onLocationFound(e) {
            if (window.userMarker) {
                window.userMarker.setLatLng(e.latlng);
            } else {
                window.userMarker = L.circleMarker(e.latlng, {
                    radius: 9, fillColor: "#2196F3", color: "#fff", weight: 3, opacity: 1, fillOpacity: 1
                }).addTo(map).bindPopup("–í–∏ —Ç—É—Ç");
            }
        }
        map.on('locationfound', onLocationFound);
        map.locate({setView: false, watch: true, enableHighAccuracy: true});

        // --- –°–ü–ò–°–û–ö –¢–û–ß–û–ö ---
        const locs = [
            {id: 1, n: "H√∂rbranz A14", lt: 47.5446, ln: 9.7407},
            {id: 2, n: "Nuziders A14", lt: 47.1731, ln: 9.7737},
            {id: 3, n: "Rabfeld A12", lt: 47.4574, ln: 11.9196},
            {id: 4, n: "Kundl A12", lt: 47.4734, ln: 11.9693},
            {id: 5, n: "Wels A8", lt: 48.1790, ln: 13.8623},
            {id: 6, n: "Wolfsbach A1 (1)", lt: 48.1120, ln: 14.6761},
            {id: 7, n: "Wolfsbach A1 (2)", lt: 48.1123, ln: 14.6786},
            {id: 8, n: "Mistelbach A5", lt: 48.5389, ln: 16.6259},
            {id: 9, n: "Bruck an der Leitha A4", lt: 48.0431, ln: 16.7791},
            {id: 10, n: "Pernau A2", lt: 47.0900, ln: 15.8511},
            {id: 11, n: "Strass in Steiermark A9", lt: 46.7317, ln: 15.6436},
            {id: 12, n: "Hainburg A2", lt: 46.6845, ln: 14.6591},
            {id: 13, n: "Arnoldstein A2", lt: 46.5492, ln: 13.7042}
        ];

        // –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –ø—Ä–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑ URL
        let savedStatuses = {};
        const urlParams = new URLSearchParams(window.location.search);
        const rawData = urlParams.get('data');
        if (rawData) {
            try { savedStatuses = JSON.parse(decodeURIComponent(rawData)); } catch (e) {}
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // --- –ú–ê–õ–Æ–í–ê–ù–ù–Ø –¢–û–ß–û–ö ---
        locs.forEach(l => {
            let markerClass = "marker-blue";let statsHtml = '<div style="color:gray; font-size:11px; margin:5px 0;">–ì–æ–ª–æ—Å—ñ–≤ —â–µ –Ω–µ–º–∞—î</div>';
            
            if (savedStatuses[l.id]) {
                const status = savedStatuses[l.id].status;
                if (status === 'red') markerClass = "marker-red";
                else if (status === 'green') markerClass = "marker-green";

                const red = savedStatuses[l.id].red_c || 0;
                const green = savedStatuses[l.id].green_c || 0;
                const total = red + green;
                
                if (total > 0) {
                    const redP = Math.round((red / total) * 100);
                    const greenP = 100 - redP;
                    statsHtml = `
                        <div style="margin: 8px 0;">
                            <div class="stat-label"><span style="color:red;">üî¥ ${redP}%</span><span style="color:green;">${greenP}% üü¢</span></div>
                            <div class="progress-bar-container">
                                <div style="width:${redP}%; background:red;"></div>
                                <div style="width:${greenP}%; background:green;"></div>
                            </div>
                            <div style="font-size:10px; color:gray; text-align:right;">–í—Å—å–æ–≥–æ: ${total}</div>
                        </div>`;
                }
            }

            // –î–æ–¥–∞—î–º–æ –º–∞—Ä–∫–µ—Ä-–∫—Ä–∞–ø–ª—é –∑ –ø–æ—Ç—Ä—ñ–±–Ω–∏–º –∫–æ–ª—å–æ—Ä–æ–º
            const marker = L.marker([l.lt, l.ln]).addTo(map).bindPopup(`
                <div style="text-align:center; min-width:170px;">
                    <b style="font-size:15px;">${l.n}</b><br>
                    ${statsHtml}
                    <hr style="margin: 8px 0; border: 0; border-top: 1px solid #eee;">
                    <div style="display: flex; gap: 6px;">
                        <button class="btn btn-g" onclick="checkPosAndSend(${l.id},'green')">–ß–ò–°–¢–û</button>
                        <button class="btn btn-r" onclick="checkPosAndSend(${l.id},'red')">–ö–û–ù–¢–†–û–õ–¨</button>
                    </div>
                </div>
            `);

            // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ –∫–æ–ª—ñ—Ä –¥–æ —ñ–∫–æ–Ω–∫–∏
            marker.on('add', function() {
                marker._icon.classList.add(markerClass);
            });
        });

        function checkPosAndSend(id, s) {
            let uLat = 0, uLon = 0;
            if (window.userMarker) {
                const loc = window.userMarker.getLatLng();
                uLat = loc.lat; uLon = loc.lng;
            }
            const target = locs.find(item => item.id === id);
            const dist = getDistance(uLat, uLon, target.lt, target.ln);

            // –¢–ï–°–¢–û–í–ê –í–Ü–î–°–¢–ê–ù–¨ 10000 –∫–º (–∑–º—ñ–Ω—ñ—Ç—å –Ω–∞ 1.5 –¥–ª—è —Ä–æ–±–æ—Ç–∏)
            if (dist <= 10000) {
                tg.sendData(JSON.stringify({id: id, status: s}));
                tg.close();
            } else {
                alert("–í–∏ –∑–∞–¥–∞–ª–µ–∫–æ!");
            }
        }
    </script>
</body>
</html>
