<!DOCTYPE html>
<html>
<head>
    <title>Austria Control Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { height: 100vh; width: 100vw; }
        .popup-content { text-align: center; font-family: sans-serif; }
        .btn { padding: 10px; margin: 5px; border: none; color: white; cursor: pointer; border-radius: 5px; }
        .btn-green { background: #28a745; }
        .btn-red { background: #dc3545; }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand(); // –†–æ–∑–≥–æ—Ä—Ç–∞—î–º–æ –Ω–∞ –≤–µ—Å—å –µ–∫—Ä–∞–Ω

        // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ —Ç–æ—á–æ–∫ (—Ç—ñ —Å–∞–º—ñ, —â–æ –≤–∏ —Å–∫–∏–Ω—É–ª–∏)
        const locations = [
            {id: 1, name: "H√∂rbranz A14", lat: 47.5446716, lon: 9.7407056},
            {id: 2, name: "Nuziders A14", lat: 47.1731061, lon: 9.7737490},
            {id: 3, name: "Rabfeld A12", lat: 47.4574499, lon: 11.9196131},
            {id: 4, name: "Kundl A12", lat: 47.4734057, lon: 11.9693550},
            {id: 5, name: "Wels A8", lat: 48.1790998, lon: 13.8623469},
            {id: 6, name: "Wolfsbach A1 (1)", lat: 48.1120424, lon: 14.6761559},
            {id: 7, name: "Wolfsbach A1 (2)", lat: 48.1123486, lon: 14.6786235},
            {id: 8, name: "Mistelbach A5", lat: 48.5389208, lon: 16.6259452},
            {id: 9, name: "Bruce an der Leitha A4", lat: 48.0431949, lon: 16.7791466},
            {id: 10, name: "Pernau A2", lat: 47.0900261, lon: 15.8511415},
            {id: 11, name: "Strass in Steiermark A9", lat: 46.7317264, lon: 15.6436314},
            {id: 12, name: "Haimburg A2", lat: 46.6845354, lon: 14.6591346}
        ];

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –º–∞–ø–∏ (—Ü–µ–Ω—Ç—Ä –ê–≤—Å—Ç—Ä—ñ—ó)
        const map = L.map('map').setView([47.5, 13.5], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // –§—É–Ω–∫—Ü—ñ—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –≤—ñ–¥—Å—Ç–∞–Ω—ñ (—Ñ–æ—Ä–º—É–ª–∞ Haversine)
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // –†–∞–¥—ñ—É—Å –ó–µ–º–ª—ñ –≤ –∫–º
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // –î–æ–¥–∞–≤–∞–Ω–Ω—è –º–∞—Ä–∫–µ—Ä—ñ–≤
        locations.forEach(loc => {
            const marker = L.marker([loc.lat, loc.lon]).addTo(map);
            
            marker.bindPopup(() => {
                const div = document.createElement('div');
                div.className = 'popup-content';
                div.innerHTML = <h3>${loc.name}</h3><p>–í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –≤–∞—à–æ—ó –≤—ñ–¥—Å—Ç–∞–Ω—ñ...</p>;

                // –ó–∞–ø–∏—Ç –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
                navigator.geolocation.getCurrentPosition(pos => {
                    const dist = getDistance(pos.coords.latitude, pos.coords.longitude, loc.lat, loc.lon);
                    
                    if (dist <= 1.0) { // –Ø–∫—â–æ –±–ª–∏–∂—á–µ 1 –∫–º
                        div.innerHTML = `<h3>${loc.name}</h3>
                            <p>–í–∏ –ø–æ—Ä—É—á (<b>${dist.toFixed(2)} –∫–º</b>). –û–Ω–æ–≤—ñ—Ç—å —Å—Ç–∞—Ç—É—Å:</p>
                            <button class="btn btn-green" onclick="updateStatus(${loc.id}, 'green')">–í—Å–µ —á–∏—Å—Ç–æ üü¢</button>
                            <button class="btn btn-red" onclick="updateStatus(${loc.id}, 'red')">–ö–æ–Ω—Ç—Ä–æ–ª—å üî¥</button>`;
                    } else {
                        div.innerHTML = `<h3>${loc.name}</h3>
                            <p style="color: grey;">–ó–º—ñ–Ω–∞ —Å—Ç–∞—Ç—É—Å—É –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –í–∏ –∑–∞–Ω–∞–¥—Ç–æ –¥–∞–ª–µ–∫–æ (<b>${dist.toFixed(2)} –∫–º</b>).</p>`;
                    }
                }, () => {
                    div.innerHTML = <h3>${loc.name}</h3><p style="color: red;">–£–≤—ñ–º–∫–Ω—ñ—Ç—å GPS –¥–ª—è –∑–º—ñ–Ω–∏ —Å—Ç–∞—Ç—É—Å—É!</p>;
                });

                return div;
            });
        });

        function updateStatus(id, color) {
            tg.sendData(JSON.stringify({location_id: id, status: color}));
            tg.close();
        }
    </script>
</body>
</html>
