<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Austria Map Control</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; }
        #map { height: 100vh; width: 100vw; }
        .btn { padding: 12px; width: 100%; margin-top: 8px; color: white; border: none; font-weight: bold; cursor: pointer; border-radius: 6px; font-size: 14px; }
        .btn-g { background: #28a745; }
        .btn-r { background: #dc3545; }
        .progress-bar-container { width: 100%; height: 10px; background: #eee; border-radius: 5px; margin: 10px 0; overflow: hidden; display: flex; }
        .stat-label { display: flex; justify-content: space-between; font-size: 12px; font-weight: bold; margin-bottom: 2px; }
    </style>
</head>
<body>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // 1. –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –º–∞–ø–∏
        const map = L.map('map').setView([47.5, 13.5], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // 2. –§—É–Ω–∫—Ü—ñ—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –≤–∞—à–æ—ó –ª–æ–∫–∞—Ü—ñ—ó (—Å–∏–Ω—è —Ç–æ—á–∫–∞)
        function onLocationFound(e) {
            if (window.userMarker) {
                window.userMarker.setLatLng(e.latlng);
            } else {
                window.userMarker = L.circleMarker(e.latlng, {
                    radius: 9,
                    fillColor: "#2196F3",
                    color: "#fff",
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 1
                }).addTo(map).bindPopup("–í–∏ —Ç—É—Ç");
            }
        }

        function onLocationError(e) {
            console.warn("GPS –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ: " + e.message);
        }

        map.on('locationfound', onLocationFound);
        map.on('locationerror', onLocationError);
        map.locate({setView: false, watch: true, enableHighAccuracy: true});

        // 3. –°–ø–∏—Å–æ–∫ –ª–æ–∫–∞—Ü—ñ–π
        const locs = [
            {id: 1, n: "H√∂rbranz A14", lt: 47.5446, ln: 9.7407},
            {id: 2, n: "Nuziders A14", lt: 47.1731, ln: 9.7737},
            {id: 3, n: "Rabfeld A12", lt: 47.4574, ln: 11.9196},
            {id: 4, n: "Kundl A12", lt: 47.4734, ln: 11.9693},
            {id: 5, n: "Wels A8", lt: 48.1790, ln: 13.8623},
            {id: 6, n: "Wolfsbach A1 (1)", lt: 48.1120, ln: 14.6761},
            {id: 7, n: "Wolfsbach A1 (2)", lt: 48.1123, ln: 14.6786},
            {id: 8, n: "Mistelbach A5", lt: 48.5389, ln: 16.6259},
            {id: 9, n: "Bruck an der Leitha A4", lt: 48.0431, ln: 16.7791},
            {id: 10, n: "Pernau A2", lt: 47.0900, ln: 15.8511},
            {id: 11, n: "Strass in Steiermark A9", lt: 46.7317, ln: 15.6436},
            {id: 12, n: "Hainburg A2", lt: 46.6845, ln: 14.6591},
            {id: 13, n: "Arnoldstein A2", lt: 46.5492, ln: 13.7042}
        ];

        // 4. –û—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –ø—Ä–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑ URL
        let savedStatuses = {};
        const urlParams = new URLSearchParams(window.location.search);
        const rawData = urlParams.get('data');
        if (rawData) {
            try { savedStatuses = JSON.parse(decodeURIComponent(rawData)); } catch (e) {}
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // 5. –ú–∞–ª—é–≤–∞–Ω–Ω—è —Ç–æ—á–æ–∫
        locs.forEach(l => {
            let markerColor = "blue";let statsHtml = '<div style="color:gray; font-size:11px; margin:5px 0;">–ì–æ–ª–æ—Å—ñ–≤ —â–µ –Ω–µ–º–∞—î</div>';
            
            if (savedStatuses[l.id]) {
                markerColor = savedStatuses[l.id].status;
                const red = savedStatuses[l.id].red_c || 0;
                const green = savedStatuses[l.id].green_c || 0;
                const total = red + green;
                
                if (total > 0) {
                    const redP = Math.round((red / total) * 100);
                    const greenP = 100 - redP;
                    statsHtml = `
                        <div style="margin: 8px 0;">
                            <div class="stat-label">
                                <span style="color:red;">üî¥ ${redP}%</span>
                                <span style="color:green;">${greenP}% üü¢</span>
                            </div>
                            <div class="progress-bar-container">
                                <div style="width:${redP}%; background:red;"></div>
                                <div style="width:${greenP}%; background:green;"></div>
                            </div>
                            <div style="font-size:10px; color:gray; text-align:right;">–í—Å—å–æ–≥–æ: ${total}</div>
                        </div>`;
                }
            }

            L.circle([l.lt, l.ln], { radius: 1500, color: markerColor === 'red' ? 'red' : (markerColor === 'green' ? 'green' : 'blue'), fillOpacity: 0.1, weight: 1 }).addTo(map);

            let m = L.marker([l.lt, l.ln]).addTo(map).bindPopup(`
                <div style="text-align:center; min-width:170px;">
                    <b style="font-size:15px;">${l.n}</b><br>
                    ${statsHtml}
                    <hr style="margin: 8px 0; border: 0; border-top: 1px solid #eee;">
                    <div style="display: flex; gap: 6px;">
                        <button class="btn btn-g" onclick="checkPosAndSend(${l.id},'green')">–ß–ò–°–¢–û</button>
                        <button class="btn btn-r" onclick="checkPosAndSend(${l.id},'red')">–ö–û–ù–¢–†–û–õ–¨</button>
                    </div>
                </div>
            `);

            m.on('add', function() {
                const el = m.getElement();
                if (el) {
                    if (markerColor === 'red') el.style.filter = "hue-rotate(120deg) brightness(95%) saturate(160%)";
                    else if (markerColor === 'green') el.style.filter = "hue-rotate(250deg) brightness(95%) saturate(160%)";
                }
            });
        });

        // 6. –§—É–Ω–∫—Ü—ñ—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –≥–æ–ª–æ—Å—É
        function checkPosAndSend(id, s) {
            if (!window.userMarker) {
                alert("–ü–æ—á–µ–∫–∞–π—Ç–µ, –ø–æ–∫–∏ GPS –≤–∏–∑–Ω–∞—á–∏—Ç—å –≤–∞—à—É –ø–æ–∑–∏—Ü—ñ—é!");
                return;
            }
            const userLoc = window.userMarker.getLatLng();
            const target = locs.find(item => item.id === id);
            const dist = getDistance(userLoc.lat, userLoc.lng, target.lt, target.ln);

            if (dist <= 10000) {
                tg.sendData(JSON.stringify({id: id, status: s}));
                tg.close();
            } else {
                alert("–í–∏ –∑–∞–¥–∞–ª–µ–∫–æ! –ü–æ—Ç—Ä—ñ–±–Ω–æ –±—É—Ç–∏ –≤ –º–µ–∂–∞—Ö 1.5 –∫–º. –í–∞—à–∞ –≤—ñ–¥—Å—Ç–∞–Ω—å: " + dist.toFixed(2) + " –∫–º");
            }
        }
    </script>
</body>
</html>
