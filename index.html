<!DOCTYPE html>
<html>
<head>
    <title>Austria Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; padding: 0; background-color: white; }
        #map { height: 100vh; width: 100vw; }
        .popup-content { text-align: center; font-family: Arial, sans-serif; min-width: 150px; }
        .btn { padding: 12px; margin: 5px; border: none; color: white; cursor: pointer; border-radius: 8px; width: 90%; font-weight: bold; }
        .btn-green { background: #28a745; }
        .btn-red { background: #dc3545; }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.expand();

        // –°–ø–∏—Å–æ–∫ –≤–∞—à–∏—Ö —Ç–æ—á–æ–∫
        const locations = [
            {id: 1, name: "H√∂rbranz A14", lat: 47.5446, lon: 9.7407},
            {id: 2, name: "Nuziders A14", lat: 47.1731, lon: 9.7737},
            {id: 3, name: "Rabfeld A12", lat: 47.4574, lon: 11.9196},
            {id: 4, name: "Kundl A12", lat: 47.4734, lon: 11.9693},
            {id: 5, name: "Wels A8", lat: 48.1790, lon: 13.8623},
            {id: 6, name: "Wolfsbach A1 (1)", lat: 48.1120, lon: 14.6761},
            {id: 7, name: "Wolfsbach A1 (2)", lat: 48.1123, lon: 14.6786},
            {id: 8, name: "Mistelbach A5", lat: 48.5389, lon: 16.6259},
            {id: 9, name: "Bruce an der Leitha A4", lat: 48.0431, lon: 16.7791},
            {id: 10, name: "Pernau A2", lat: 47.0900, lon: 15.8511},
            {id: 11, name: "Strass in Steiermark A9", lat: 46.7317, lon: 15.6436},
            {id: 12, name: "Haimburg A2", lat: 46.6845, lon: 14.6591}
        ];

        // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–∞—Ä—Ç–∏ (—Ü–µ–Ω—Ç—Ä –ê–≤—Å—Ç—Ä—ñ—ó)
        const map = L.map('map').setView([47.8, 13.0], 7);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        // –§—É–Ω–∫—Ü—ñ—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –≤—ñ–¥—Å—Ç–∞–Ω—ñ
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // –î–æ–¥–∞—î–º–æ —Ç–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç—É
        locations.forEach(loc => {
            const marker = L.marker([loc.lat, loc.lon]).addTo(map);
            
            marker.on('click', function() {
                // –ü–∏—Ç–∞—î–º–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –ü–†–ò –ö–õ–Ü–ö–£ –Ω–∞ —Ç–æ—á–∫—É
                navigator.geolocation.getCurrentPosition(pos => {
                    const dist = getDistance(pos.coords.latitude, pos.coords.longitude, loc.lat, loc.lon);
                    
                    let content = <div class="popup-content"><h3>${loc.name}</h3>;
                    if (dist <= 1.5) { // –î–æ–∑–≤–æ–ª—è—î–º–æ 1.5 –∫–º –¥–ª—è –Ω–∞–¥—ñ–π–Ω–æ—Å—Ç—ñ
                        content += `<p>–í–∏ –ø–æ—Ä—É—á!</p>
                                    <button class="btn btn-green" onclick="sendStat(${loc.id}, 'green')">–ß–∏—Å—Ç–æ üü¢</button>
                                    <button class="btn btn-red" onclick="sendStat(${loc.id}, 'red')">–ö–æ–Ω—Ç—Ä–æ–ª—å üî¥</button>`;
                    } else {
                        content += <p style="color:red">–î–∞–ª–µ–∫–æ (${dist.toFixed(1)} –∫–º).<br>–ó–º—ñ–Ω–∞ —Å—Ç–∞—Ç—É—Å—É –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.</p>;
                    }
                    content += </div>;
                    marker.bindPopup(content).openPopup();
                }, () => {
                    marker.bindPopup(`<div class="popup-content"><h3>${loc.
                                                                       name}</h3><p style="color:red">–£–≤—ñ–º–∫–Ω—ñ—Ç—å GPS!</p></div>`).openPopup();
                });
            });
        });

        function sendStat(id, status) {
            tg.sendData(JSON.stringify({id: id, status: status}));
            tg.close();
        }
    </script>
</body>
</html>
